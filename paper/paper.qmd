---
title: Paper
authors:
  - name: Alessandro Gerada
    affiliation: University of Liverpool
    roles: writing
    corresponding: true
bibliography: references.bib
---

# Background

```{r setup, include=FALSE}
# here::i_am("paper/index.qmd")
run_sims <- FALSE

# I could not get R code to run before, until I did this:
# https://github.com/brentthorne/posterdown/issues/42

# to change body font size:
# change this line in typst-template.typ:
# set text(font: "STIX Two Text", size: 24pt)
library(tidyverse)
library(abc)
library(lhs)
library(flextable)
```

```{r}
# print(here::here())
# file.exists(here::here("scripts", "calibrate.R"))
```

```{r load-data, include=FALSE}
# print(file.exists(here::here("scripts", "calibrate.R")))
# source(here::here("scripts", "calibrate.R"))
source(file.path("..", "scripts", "calibrate.R"), chdir = TRUE)
# load(file.path("..", "out", "calibrate.RData"))
```

Transmission of potentially pathogenic bacteria under antimicrobial selective pressure has important implications for control of hospital-acquired infection.
Examples of such pathogens include *Clostridioides difficile* infection (CDI), vancomycin-resistant *Enterococcus* (VRE), extended-spectrum beta-lactamase-producing (ESBL) Enterobacterales, and carbapenem-resistant Enterobacterales (CPE).
Infection with these pathogens can lead to increased morbidity and mortality -- for example, CPE bloodstream infection is associated with an increased risk of in-hospital mortality (risk difference of 0.25) compared to carbapenem-susceptible infection [@budhramHealthOutcomesAttributable2020].
_C. difficile_ infection is associated with prolonged hospital stay and increased healthcare costs, causing a significant operational burden [@forsterEffectHospitalacquiredInfection2012].
Furthermore, the therapeutic antimicrobial options available for VRE, ESBL, and CPE are limited, leading to increased use of WHO reserve agents, which further exacerbates the problem of antimicrobial resistance [@organization2019WHOAWaRe2019].

Infection prevention and control (IPC) strategies are essential to prevent the spread of these pathogens within a healthcare setting, and include measures such as hand hygiene, environmental cleaning, isolation of infected/colonised patients, and more [@worldhealthorganizationGlobalReportInfection2022].
In many healthcare settings, IPC strategies and operational practices are led by a multi-disciplinary IPC team.
A key role of IPC teams is to prepare for, declare, investigate, and control outbreaks of healthcare-associated infections.
In practice, an outbreak is declared after rates of infection have been compared to historical rates, and this is followed by a series of interventions to control the outbreak.
These interventions may include increased frequency and thoroughness of environmental cleaning, cohorting of infected/colonised patients (particularly into single-occupancy _en suite_ rooms), and increased hand hygiene compliance.
The impact of these interventions is often difficult to quantify.
Although evidence suggests that the interventions can help control outbreaks, studies almost always report their findings after a suite of interventions have been implemented -- therefore, the relative importance of each intervention is not usually quantifiable.
Furthermore, studies report findings from a population that may be very different from the outbreak population being managed -- differences can range from patient factors such as co-morbidities and rates of antimicrobial resistance, to institution practices such rates of antimicrobial usage, and to structural differences such as hospital layout.

In practice, the approach to managing outbreaks is often reactive.
Once an outbreak is identified and declared, the IPC team implements a set of enhanced infection control measures to attempt to attempt to halt transmission.
The number of cases of infection or colonisation is monitored over a time frame dependent on the pathogen, setting, and scale of the outbreak.
If the measures are successful in controlling the spread, then they are gradually relaxed once rates return to baseline.
If they are not, then further measures are implemented, or the existing measures are intensified, until control is achieved.

In addition to patient factors, the risk of infection and/or colonisation depends on environmental factors (e.g., surface cleaning), proximity to other colonised patients, and use of antimicrobial agents.

To guide infection control strategies, especially during outbreaks, we developed an agent-based simulator and estimated its parameters using data from a CDI outbreak documented by @salgadoAnalysisOutbreakClostridium2009.

# Methods

## Agent-based model

An agent-based model (ABM) was implemented using NetLogo [@wilenskyu.NetLogo1999]. Briefly, the simulation started by building a virtual hospital with a configurable high-level structure, defined by its number of wards, beds per ward, and proportion of bedspaces sharing toilet facilities. Next, the hospital was populated with patients, each having an infected/colonised or non-infected/colonised state, defined as:

$$
x_p(t) \epsilon \{0, 1\}
$$

where:

-   $x_p(t) = 0$ if patient $p$ is not infected/colonised at time $t$,
-   $x_p(t) = 1$ if patient $p$ is infected/colonised at time $t$.

It was assumed that infection/colonisation was not reversible during the simulation, i.e., that infected/colonised patients remained so until discharge. At each time increment, the probability of a non-colonised/infected patient acquiring infection (i.e., transitioning from a non-infected/colonised to infected/colonised state) depended on: 1) a baseline risk of *de novo* infection/colonisation:

$$ 
P_\text{de novo}(t) = 1 - \text{Exp} {( - r_0 T(t) )},
$$

and 2) the usage of contaminated toilets:

$$
P_\text{toilet}(t) = 1 - \text{Exp} ( {-\sum_{j=0}^{U_i(t)}[C(t_j) \cdot T(t)]} )
$$

where:

-   $R_i(t)$ is the risk of patient $i$ acquiring infection/colonisation at time $t$,

-   $r_0$ is the baseline/*de novo* risk of infection/colonisation,

-   $T(t)$ is a binary indicator for antimicrobial therapy:

$$
T(t) = \begin{cases}
    m & \text{if on antimicrobial therapy} \\ % & is your "\tab"-like command (it's a tab alignment character)
    1 & \text{otherwise.}
\end{cases}
$$

-   $m$ is the increased (or decreased) relative risk of infection/colonisation due to antimicrobial therapy,

-   $U_i(t)$ is the number of times patient $i$ frequents the toilet within the time interval $t$,

-   $C(t_j)$ is the contamination level of the toilet at time $t_j$.

The agent-based model conducted Bernoulli trials to determine if a patient acquired infection/colonisation at each time step $t$:

$$
X_\text{de novo} \sim \text{Bernoulli}(P_\text{de novo}(t)),
$$

where $X_\text{de novo}$ = 1 if patient acquires infection/colonisation *de novo* at time $t$, and 0 otherwise.

$$
X_\text{toilet} \sim \text{Bernoulli}(P_\text{toilet}(t)),
$$

where $X_\text{toilet}$ = 1 if patient acquires infection/colonisation from a contaminated toilet at time $t$, and 0 otherwise.

The results of the trials were combined to determine the outcome for patient $i$ at time $t$:

$$
X_i(t) = \text{Max}(X_\text{de novo}, X_\text{toilet}),
$$

where $X_i(t)$ = 1 if patient $i$ acquires infection/colonisation at time $t$, and 0 otherwise.

A deterministic representation of the model was described in terms of the following differential equations, an adaptation of *SI* (susceptible--infection) models [@andersonDiscussionKermackMcKendrickEpidemic1991; @keelingModelingInfectiousDiseases2011]:

$$
\frac{dS}{dt} = pA - D \cdot \frac{S}{S + I} - \beta S - rS
$$

$$
\frac{dI}{dt} = (1 - p)A - D \cdot \frac{I}{S + I} + \beta S + rS
$$

where:

-   $dS/dt$ is the rate of change of susceptible/non-infected inpatients,
-   $S$ is the number of susceptible inpatients,
-   $I$ is the number of infected/colonised inpatients,
-   $A$ is the rate of new admissions,
-   $p$ is the proportion of new admissions that are susceptible/non-infected, while $(1 - p)$ is community colonisation/infection rate,
-   $\beta$ is the transmission coefficient,
-   $r$ is the rate of random (*de novo*) colonisation/infection,
-   $D$ is the rate of patient discharges.

The hospital capacity was constantly kept at 100% occupancy (i.e., patients were immediately replaced on discharge), therefore, $D = A$.

## Model inputs and outputs

Model input parameters were broadly grouped into: 1) toilet (e.g., number of times toilet used per day, level of contamination after use or cleaning); 2) admission (e.g., community colonisation rate, antimicrobial prescription rate); and 3) colonisation parameters (e.g., relative risk increase of antimicrobial therapy on colonisation/infection).

The outputs of the model included: 1) number of patients admitted; 2) number of patients with community-acquired colonisation/infection; 3) number of patients with hospital-acquired (nosocomial) colonisation/infection. The simulation was run with each unit of time corresponding to one day; therefore, the model's outputs were for each simulated day.

## Data sources

Data from a hospital *Clostridioides difficile* infection (CDI) outbreak reported by Salgado et al was used to parameterise and calibrate the model [@salgadoAnalysisOutbreakClostridium2009]. Raw data from this study were not available, therefore, the Engauge digitizer software was used to extract observed CDI rates from the manuscript's figures [@mitchellEngaugeDigitizer2020].

## Model calibration {#sec-model-calibration}

Rejection sampling approximate Bayesian computation (ABC) was employed to calibrate the model to the outbreak data [@sunnakerApproximateBayesianComputation2013]. Priors were determined from domain knowledge or extracted from existing literature. A summary of the priors used is available in @tbl-priors.

Firstly, latin hypercube sampling was used to generate $n$ samples from the parameter prior distributions, using a uniform distribution, such that $\theta_1,\theta_2,\ldots,\theta_n$. Next, each sample parameter point $\theta_i$ was used as an input to the agent-based simulation model, generating a total of $n$ simulated datasets. The number of daily cases of nosocomial CDI were extracted from the model outputs, and converted to a time series of nosocomial CDI per 1000 patient days for each month, generating simulated summary statistics $S_1,S_2,\ldots,S_n$. Results from the first 31 simulated days were discarded to ensure that the model had reached a steady state.

Each simulated summary statistic $S_i$ was compared to the summary statistic generated from the observed data, $S_\text{obs}$, and $S_i$ was accepted if:

$$
d(S_i, S_\text{obs}) \leq \epsilon,
$$

where:

-   $d$ is the Euclidean distance between $S_i$ and $S_\text{obs}$, and

-   $\epsilon$ is the tolerance.

Otherwise, $S_i$ was rejected. The parameter samples that generated the accepted simulations were used to produce a posterior distribution. $\epsilon$ was set so that the acceptance rate was approximately 2.5%.

The approach to calibration was sequential. Firstly, ABC was used to calibrate the model pre-outbreak data to identify parameters that simulated the baseline rate. Next, the posterior distribution of the baseline rate model was used as a prior for a model that extended the simulation into the period of CDI outbreak and implementation of enhanced IPC measures (October 2004--May 2005 in the observed dataset) [@salgadoAnalysisOutbreakClostridium2009]. To simulate the emergence of an outbreak, the model changed parameters at a discrete time point corresponding to the outbreak onset. The priors used for ABC were selected to be compatible with increased transmission or colonisation rates, for example increased antimicrobial exposure and decreased toilet cleaning frequency. At a subsequent discrete time point, the model again changed parameters to simulate enhanced infection control measures. The prior distributions for these parameters were selected to decrease transmission and colonisation -- generally the reverse of the 'outbreak' parameters.

The posterior parameter distributions were used to simulate `r length(unique(consts_sim$siminputrow))` outbreak scenarios. Parameter samples were drawn from a uniform distribution:

$$
U_[a,b] = U(\mu - \sigma, \mu + \sigma),
$$

where: $\mu$ and \$\sigma\$ are the mean and standard deviation of the posterior distribution, respectively. The simulated rates of nosocomial CDI were compared to the observed rates to assess the model's performance. One of the simulation runs was compared to the deterministic model, which was numerically integrated using Euler's method. Since the agent-based model was stochastic, all simulations were aggregated

| Name | Distribution | Parameters | Description | Reference |
|---------------|---------------|---------------|---------------|---------------|
| Baseline (pre-outbreak) antimicrobial prescription rate | Constant | 49.9% | Proportion of patients administered antimicrobials during admission | @versportenAntimicrobialConsumptionResistance2018 |
| Admission duration | Poisson | $\lambda = 4.6  \text{ days}$ |  | @levitkryankelixhauserastrangesekassedccoffeyrHCUPFactsFigures2007 |
| Proportion of toilets that are shared between \>1 patients | Constant | 60% | The remaining proportion (40%) of toilets were dedicated to one patient | N/A |
| Community colonisation rate | Uniform | $a = 0.01, b = 0.1$ |  | @crobachUnderstandingClostridiumDifficile2018 |
| Antimicrobial effect | Uniform | \$ a = 1.31, b = 1.87 \$ | Odds ratio for effect of antimicrobial therapy on risk of hospital-acquired CDI | @slimingsAntibioticsHospitalacquiredClostridium2014 |
| CDI incidence | Uniform | $a=2.8, b=12.1$ | Per 10,000 patient-days | @marraIncidenceOutcomesAssociated2020 |
| Mean toilet frequenting rate | Uniform | $a=0.5,b=5$ | Per day; used as \lambda parameter for Poisson distribution |  |
| Mean toilet cleaning rate | Uniform | $a=0.5, b=3$ | Per day; used as \lambda parameter for Poisson distribution |  |
| Toilet contamination effect | Uniform | $a=0.01,b=0.99$ | Contamination impact by infected/colonised patients through toilet use |  |
| Toilet cleaning effect | Uniform | $a=0.01, b=0.99$ | Impact of toilet cleaning on contamination |  |

: Parameter prior distributions or constants. {#tbl-priors}

![Screenshot of model graphical user interface during a simulation run](./images/screenshot.png){#fig-screenshot height="30%"}

Users can run the model interactively using the interface shown in @fig-screenshot.

## Outbreak generation {#sec-outbreak-generation}

To simulate the generation of outbreaks and their subsequent control through enhanced infection prevention and control (IPC) measures, the agent-based model optionally changed its parameters at four configurable discrete time points within the simulation: 1) onset of outbreak; 2) start of enhanced IPC measures; 3) end of outbreak; and 4) end of enhanced IPC measures. During calibration, the upper or lower bounds for parameter priors during the outbreak period were extended by 50% of baseline. For example, the upper bound of prior for the parameter determining the rate of antimicrobial prescriptions was 50% higher than the baseline rate. On the other hand, these parameters were reversed to control the outbreak.

## Sensitivity analysis {#sec-sens-analysis}

```{r, include=FALSE}
sens_n_seeds <- length(unique(consts_sim$siminputrow))
```


To assess the sensitivity of the calibrated model to changes in parameters, a single-parameter local sensitivity analysis was performed [@railsback232SensitivityAnalysis2019]. Four parameters that reflected modifiable infection control practices were chosen for the sensitivity analysis: 1) antimicrobial prescription rates; 2) proportion of patients redistributed to a single-occupancy bed after colonisation/infection; 3) toilet cleaning rate; and 4) toilet cleaning effect. To conduct the sensitivity analysis, all the parameters except the one of interest were fixed at the posterior mean values, determined using the rejection ABC. Next, the parameter of interest was varied through a range of values, and used as an input to the simulation model at each value. The output metric was the number of cases of hospital-acquired infection/colonisation within the outbreak period. For each parameter value, the simulation was run with `r sens_n_seeds` different random number generator seeds to account for stochasticity in the model -- the output metric was the mean number of cases across the `r sens_n_seeds` runs.

## Software implementation

The agent-based model was implemented in NetLogo v6.2.2 [@wilenskyu.NetLogo1999]. The R package `nlrx` was used to execute simulations and transfer output data for analysis in R [@rcoreteamLanguageEnvironmentStatistical2022; @saleckerNlrxPackageNextgeneration2019].

# Results

```{r, include=FALSE}
posteriors <- abc_params_outbreak_control$unadj.values
comm_colonisation <- round(mean(posteriors[, "community-colonisation-rate"] * 100), 2)
outbreak_colonisation <- round(mean(posteriors[, "o-community-colonisation-rate"] * 100), 2)
outbreak_antibiotic_rate <- round(mean(posteriors[, "o-antibiotic-prescription-rate"] * 100), 2)
control_antibiotic_rate <- round(mean(posteriors[, "c-antibiotic-prescription-rate"] * 100), 2)
b_toilet_clean_rate <- round(mean(posteriors[, "toilet-cleaning-rate"]), 2)
o_toilet_clean_rate <- round(mean(posteriors[, "o-toilet-cleaning-rate"]), 2)
c_toilet_clean_rate <- round(mean(posteriors[, "c-toilet-cleaning-rate"]), 2)
```

An agent-based model that simulates the faecal-oral transmission of infection or colonisation in a hospital setting was produced. After calibrating the agent-based model using approximate Bayesian computation (ABC), three groups of parameters were produced: 1) baseline parameters, which aimed to generate similar rates of infection to the basal rate (i.e., pre- and post-outbreak); 2) outbreak parameters, which led to the increased transmission observed during the outbreak period; and 3) control parameters, which reflect enhanced infection control practice that led to outbreak control. A summary of the posterior estimates of the parameters (reported as the mean and standard deviation of the parameters from the rejection ABC) is shown in @tbl-posteriors. The densities of the posterior parameter distributions are shown in @fig-posterior-densities. In line with the prior bounds described in @sec-outbreak-generation, the posterior distributions of the parameters were consistent with the expected changes in the parameters during the outbreak and control periods (e.g., the toilet cleaning rate changed from `r b_toilet_clean_rate` to `r o_toilet_clean_rate`, and to `r c_toilet_clean_rate` during the baseline, outbreak, and control periods respectively).

```{r tbl-posteriors, include=TRUE}
#| tbl-cap: "Summary of parameter posteriors after calibration using Approximate bayesian computation."
#| echo: false
params_table <- abc_params_outbreak_control$unadj.values %>% 
  as_tibble() %>% 
  mutate("community-colonisation-rate" = `community-colonisation-rate` * 100,
         "o-community-colonisation-rate" = `o-community-colonisation-rate` * 100,
         "o-antibiotic-prescription-rate" = `o-antibiotic-prescription-rate` * 100,
         "c-antibiotic-prescription-rate" = `c-antibiotic-prescription-rate` * 100) %>% 
  dplyr::select(!any_of(c("outbreak-start", "outbreak-end", "control-end"))) %>%
  dplyr::rename_with(.fn = \(.x) paste0("b-", .x), .cols = !starts_with("o-") & !starts_with("c-")) %>% 
  summarise(across(everything(), ~ paste0(
    round(mean(.x), 2),
    " (",
    round(sd(.x), 2),
    ")"
    )))

param_units <- c("toilet-frequenting-rate" = "times per day",
                 "toilet-cleaning-rate" = "times per day",
                 "toilet-contamination-effect" = "",
                 "toilet-cleaning-effect" = "",
                 "community-colonisation-rate" = "percentage of patients",
                 "antibiotic-prescription-rate" = "percentage of admissions",
                 "antibiotic-effect" = "relative risk",
                 "random-colonisation" = "cases per 10,000 bed days",
                 "proportion-redistributed" = "proportion of patients")

param_names <- c("toilet-frequenting-rate" = "Toilet frequenting rate",
                 "toilet-cleaning-rate" = "Toilet cleaning rate",
                 "toilet-contamination-effect" = "Toilet contamination effect",
                 "toilet-cleaning-effect" = "Toilet cleaning effect",
                 "community-colonisation-rate" = "Community colonisation rate",
                 "antibiotic-prescription-rate" = "Antibiotic prescription rate",
                 "antibiotic-effect" = "Antibiotic effect",
                 "random-colonisation" = "Random colonisation",
                 "proportion-redistributed" = "Proportion redistributed")

params_table %>% 
  pivot_longer(cols = everything(), names_to = c("period", "param"), values_to = "value",
               names_pattern = "(b|o|c)-(.*)") %>% 
  pivot_wider(names_from = period, values_from = value) %>% 
  # reorder cols
  dplyr::select(param, b, o, c) %>% 
  dplyr::rename(baseline = b, outbreak = o, control = c) %>% 
  mutate(units = param) %>% 
  relocate(units, .after = param) %>%
  flextable() %>% 
  labelizor(j = "units", part = "body",
            labels = param_units) %>% 
  labelizor(j = "param", part = "body",
            labels = param_names) %>% 
  width(width = 1) %>% 
  font(fontname="Times New Roman",
       part = "all") %>% 
  fontsize(size = 10, part = "all")
```

```{r fig-posterior-densities, include=TRUE}
#| eval: true
#| echo: false
#| fig.width: 18
#| fig.height: 8
#| warning: false
#| label: fig-posterior-densities
#| fig-cap: "Changes in parameters during outbreak and enhanced infection control periods. Density plots show the posterior distributions of key simulation parameters after calibration using approximate Bayesian computation."
#| fig-subcap:
#|   - "General parameters"
#|   - "Toilet-related parameters"
#| layout-ncol: 1
abc_params_outbreak_control$unadj.values %>% 
  as_tibble %>% 
  dplyr::select(-`outbreak-start`, -`outbreak-end`, -`control-end`,
                -`antibiotic-effect`,
                -`random-colonisation`) %>% 
  dplyr::select(!contains("toilet")) %>% 
  pivot_longer(cols=everything()) %>%
  mutate(type = case_when(
    str_starts(name, "o-") ~ "Outbreak",
    str_starts(name, "c-") ~ "Control",
    .default = "Baseline")) %>%
  mutate(name = str_remove(name, "^o-|^c-")) %>%
  mutate(name = str_replace_all(name, "-", " ")) %>%
  mutate(name = str_to_title(name)) %>% 
  # change type to ordered factor
  mutate(type = factor(type, levels = c("Baseline", "Outbreak", "Control"))) %>%
  ggplot(aes(x = value, ..scaled.., fill = type)) +
  geom_density(alpha = 0.1) +
  facet_wrap(~name, scales = "free_x") +
  # remove y axis
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("Parameter value") + 
  theme(legend.title = element_blank(),
        text=element_text(size=24)) + 
  # manually set colors
  scale_fill_manual(values = c("Baseline" = "green", "Outbreak" = "red", "Control" = "blue"))

abc_params_outbreak_control$unadj.values %>% 
  as_tibble %>% 
  dplyr::select(-`outbreak-start`, -`outbreak-end`, -`control-end`,
                -`antibiotic-effect`,
                -`random-colonisation`) %>% 
  dplyr::select(contains("toilet")) %>% 
  pivot_longer(cols=everything()) %>%
  mutate(type = case_when(
    str_starts(name, "o-") ~ "Outbreak",
    str_starts(name, "c-") ~ "Control",
    .default = "Baseline")) %>%
  mutate(name = str_remove(name, "^o-|^c-")) %>%
  mutate(name = str_replace_all(name, "-", " ")) %>%
  mutate(name = str_to_title(name)) %>% 
  # change type to ordered factor
  mutate(type = factor(type, levels = c("Baseline", "Outbreak", "Control"))) %>%
  ggplot(aes(x = value, ..scaled.., fill = type)) +
  geom_density(alpha = 0.1) +
  facet_wrap(~name, scales = "free_x") +
  # remove y axis
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("Parameter value") + 
  theme(legend.title = element_blank(),
        text=element_text(size=24)) + 
  # manually set colors
  scale_fill_manual(values = c("Baseline" = "green", "Outbreak" = "red", "Control" = "blue"))
```

Using the posterior distributions as inputs to the simulation model, as described in @sec-model-calibration, the model was able to generate scenarios of outbreaks that closely matched the observed data (see @fig-simulated-rates). In these simulated scenarios, the pre-outbreak baseline rate was a median of `r round(pre_outbreak_sims_rates$rate_mean, 2)` cases per 1000 patient days \[interquartile (IQR) range `r round(pre_outbreak_sims_rates$rate_q_low, 2)`--`r round(pre_outbreak_sims_rates$rate_q_high, 2)`\], compared with the real rate of 1.25 cases per 1000 \[IQR 0.94--1.56\]. During the outbreak period, simulations had a mean rate of `r round(outbreak_sims_rates$rate_mean, 2)` \[IQR `r round(outbreak_sims_rates$rate_q_low, 2)`--`r round(outbreak_sims_rates$rate_q_high, 2)`\] cases, compared with the real mean rate of 3.74 \[IQR 3.32--4.41\] (see @fig-simulated-rates).

```{r fig-abc-rates-retained-posterios, include=TRUE}
#| echo: false
#| label: fig-abc-rates-retained-posteriors
#| fig.cap: "Observed and simulated rates of _C. difficile_ infection over the simulated period. Approximate Bayesian computation was used to determine the unobserved parameters of the agent-based model. The red line shows the true observed infection rates. The black solid line shows the mean simulated rates; the dashed lines show the standard deviation."
#| fig.width: 18
#| fig.height: 8
ggplot(long_observed_ss, aes(x = x, y = rates)) + geom_line(color = 'red') +
  geom_line(data = sim_mean, aes(x = x, y = m)) +
  geom_line(data = sim_mean, aes(x = x, y = q_high), linetype='dashed') +
  geom_line(data = sim_mean, aes(x = x, y = q_low), linetype='dashed') + 
  theme(text=element_text(size=24)) +
  xlab("Date") + ylab("Rate (cases per 1000 patient days)")
```

```{r fig-consts-sims-coloured, include=TRUE}
#| echo: false
#| fig.width: 18
#| fig.height: 8
#| message: false
consts_sim_rates %>% 
  pivot_wider(names_from = date_sim, values_from = rate) %>% 
  #slice_sample(n=10) %>% 
  pivot_longer(cols = !c(`random-seed`, `siminputrow`), names_to = "date_sim", values_to = "rate") %>% 
  mutate(date_sim = ymd(date_sim)) %>% 
  group_by(siminputrow, date_sim) %>%
  summarise(rate = mean(rate)) %>%
  ggplot(aes(x = date_sim,
             y = rate,
             color = factor(`siminputrow`))) +
  geom_line() +
  geom_line(data = long_observed_ss, aes(x = x, y = rates), color = "black") +
  guides(color="none")
```

```{r fig-consts-sims-mean-sd, include=TRUE}
# plot but with mean and sd instead rather than individual
consts_sim_rates %>% 
  pivot_wider(names_from = date_sim, values_from = rate) %>% 
  pivot_longer(cols = !c(`random-seed`, `siminputrow`), names_to = "date_sim", values_to = "rate") %>% 
  mutate(date_sim = ymd(date_sim)) %>% 
  group_by(date_sim) %>%
  summarise(m = mean(rate),
            q_high = quantile(rate, 0.75),
            q_low = quantile(rate, 0.25),
            .groups = "keep") %>%
  ggplot() +
  geom_line(aes(x = date_sim, y = m)) +
  geom_line(aes(x = date_sim, y = q_high), linetype='dashed') +
  geom_line(aes(x = date_sim, y = q_low), linetype='dashed') + 
  geom_line(data = long_observed_ss, aes(x = x, y = rates), color = "red") +
  guides(color="none")
```

```{r fig-single-outbreak-coloured, include=TRUE}
#| echo: false
#| fig.width: 18
#| fig.height: 8
#| message: false
single_outbreak_sim_rates %>% 
  pivot_wider(names_from = date_sim, values_from = rate) %>% 
  #slice_sample(n=10) %>% 
  dplyr::select(!`siminputrow`) %>% 
  pivot_longer(cols = !c(`random-seed`), names_to = "date_sim", values_to = "rate") %>% 
  mutate(date_sim = ymd(date_sim)) %>% 
  group_by(date_sim, `random-seed`) %>%
  summarise(rate = mean(rate)) %>%
  ggplot(aes(x = date_sim,
             y = rate,
             color = factor(`random-seed`))) +
  geom_line() +
  geom_line(data = long_observed_ss, aes(x = x, y = rates), color = "black") +
  guides(color="none")
```

```{r fig-single-outbreak, include=FALSE}
single_outbreak_sim_mod <- single_outbreak_sim %>% 
  mutate(prop_infected = `current-colonised` / `current-inpatients`,
         current_not_infected = `current-inpatients` - `current-colonised`)
single_outbreak_sim_mod %>% 
  pivot_longer(cols = c(`current-colonised`, `current_not_infected`), names_to = "compartment", values_to = "value") %>%
  ggplot(aes(x = `[step]`, y = value, color = compartment)) +
  geom_line() +
  labs(title = "Dynamics of Non-Infected and Infected Patients (Time-Varying Beta)",
       x = "Time",
       y = "Number of Patients",
       color = "Compartment") 

# single_outbreak_sum_stat <- single_outbreak_sim_mod %>% 
#   group_by(`[step]`) %>%
#   summarise(m = mean(prop_infected))
```

```{r fig-posterior-predictive-check, include=TRUE}
#| echo: false
posterior_predictive_sim_rates %>% 
  pivot_wider(names_from = date_sim, values_from = rate) %>% 
  pivot_longer(cols = !c(`random-seed`, `siminputrow`), names_to = "date_sim", values_to = "rate") %>% 
  mutate(date_sim = ymd(date_sim)) %>% 
  group_by(date_sim) %>%
  summarise(m = median(rate),
            q_high = quantile(rate, 0.75),
            q_low = quantile(rate, 0.25),
            .groups = "keep") %>%
  ggplot() +
  geom_line(aes(x = date_sim, y = m)) +
  geom_line(aes(x = date_sim, y = q_high), linetype='dashed') +
  geom_line(aes(x = date_sim, y = q_low), linetype='dashed') + 
  geom_line(data = long_observed_ss, aes(x = x, y = rates), color = "red") +
  guides(color="none")
```

```{r fig-posterior-predictive-check-coloured, include=TRUE}
#| echo: false
#| message: false
posterior_predictive_sim_rates %>% 
  pivot_wider(names_from = date_sim, values_from = rate) %>% 
  #slice_sample(n=10) %>% 
  pivot_longer(cols = !c(`random-seed`, `siminputrow`), names_to = "date_sim", values_to = "rate") %>% 
  mutate(date_sim = ymd(date_sim)) %>% 
  group_by(siminputrow, date_sim) %>%
  summarise(rate = mean(rate)) %>%
  ggplot(aes(x = date_sim,
             y = rate,
             color = factor(`siminputrow`))) +
  geom_line() +
  geom_line(data = long_observed_ss, aes(x = x, y = rates), color = "black") +
  guides(color="none")
```

The sensitivity analysis explored the impact of different infection control practices on the number of cases observed during the outbreak period -- the results are shown in @fig-sensitivity-analysis. The analysis showed that the cleaning of toilets had a dramatic impact on the number of cases observed during the outbreak period, although the benefit appeared to plateaeu beyond a certain amount -- for example, cleaning toilets more than twice per day appeared to have marginal benefits. The number of hospital acquired cases did not appear to be sensitive to the antimicrobial prescription rate during the outbreak period. The cohorting of patients into single-occupancy rooms after colonisation/infection had an almost linear relationship with the number of cases. 

```{r fig-sensitivity-analysis, include=TRUE, eval=TRUE}
#| echo: false
list(abx_prescription_rate = sens_abx_prescription_outbreak_cases,
     proportion_redistributed = sens_prop_redist_outbreak_cases,
     toilet_cleaning_rate = sens_toilet_cleaning_rate_outbreak_cases,
     toilet_cleaning_effect = sens_toilet_cleaning_effect_outbreak_cases) %>%
  bind_rows() %>% 
  pivot_longer(cols = starts_with("c-"),
               names_to = "param",
               values_drop_na = TRUE) %>% 
  group_by(param, value) %>% 
  summarise(mean_cases = mean(`outbreak-cases`),
            sd_cases = sd(`outbreak-cases`),
            .groups = "keep") %>% 
  ggplot(aes(x = value, y = mean_cases)) + 
  geom_line() + 
  # shade sd
  geom_ribbon(aes(ymin = mean_cases - sd_cases, ymax = mean_cases + sd_cases), alpha = 0.2) +
  facet_wrap(~ param, scales = "free")
```

```{r fig-sensitvity-pre-outbreak-abx, include=TRUE, eval=TRUE}
sens_abx_prescription_pre_outbreak_outbreak_cases %>% 
  group_by(`antibiotic-prescription-rate`) %>% 
  summarise(mean_cases = mean(`outbreak-cases`),
            sd_cases = sd(`outbreak-cases`)) %>% 
  ggplot(aes(x = `antibiotic-prescription-rate`, y = mean_cases)) +
  geom_line() + 
  # add sd
  geom_line(data = . %>% 
              mutate(upper = mean_cases + sd_cases,
                     lower = mean_cases - sd_cases),
            aes(y = upper), linetype = "dashed") +
  geom_line(data = . %>% 
              mutate(upper = mean_cases + sd_cases,
                     lower = mean_cases - sd_cases),
            aes(y = lower), linetype = "dashed")
```

```{r run-deterministic-model, include=FALSE, cache=TRUE}
# Parameters and time-dependent functions
parameters <- list(
  # p = 1 - unique(single_outbreak_sim$`community-colonisation-rate`),      # Proportion of non-infected admissions
  A = 50        # Total admission/discharge rate
)
# 

single_seeds <- unique(single_outbreak_sim$`random-seed`)
single_outbreak_one_seed <- single_outbreak_sim_mod %>% 
  filter(`random-seed` == single_seeds[3])

target_baseline_rate <- single_outbreak_one_seed %>%
  filter(`[step]` > 30 & `[step]` < 200) %>%
  summarise(prop_infected = mean(prop_infected)) %>% 
  pull(prop_infected)
target_outbreak_rate <- single_outbreak_one_seed %>%
  filter(`[step]` > 1100 & `[step]` < 1200) %>%
  summarise(prop_infected = mean(prop_infected)) %>% 
  pull(prop_infected)

randomLHS <- randomLHS(10000, 5)

baselinerate <- qunif(randomLHS[, 1], 0.0005, 0.01)
outbreakrate <- qunif(randomLHS[, 2], 0.0005, 0.01)
baselinecolonisation <- qunif(randomLHS[, 3], 0.9, 0.99)
outbreakcolonisation <- qunif(randomLHS[, 4], 0.9, 0.99)
r <- qunif(randomLHS[, 5], 0.0001, 0.001)
# rate_grid <- expand.grid(b_base = baselinerate,
#                          b_out = outbreakrate,
#                          c_base = baselinecolonisation,
#                          c_out = outbreakcolonisation,
#                          r = r)
rate_grid <- data.frame(b_base = baselinerate,
                        b_out = outbreakrate,
                        c_base = baselinecolonisation,
                        c_out = outbreakcolonisation,
                        r = r)
rate_grid <- rate_grid %>% 
  filter(b_base < b_out & c_base > c_out) %>% 
  slice_sample(n = 300)

# Time-varying beta function (example: sinusoidal variation over time)
beta_function <- function(t, baseline_rate, outbreak_rate) {
  if (t > unique(single_outbreak_sim$`outbreak-start`) &
      t < unique(single_outbreak_sim$`outbreak-end`)) {
    return (outbreak_rate)
  }
  return (baseline_rate)
}

run_to <- max(single_outbreak_sim$`[step]`)

# Initial conditions
total_patients <- unique(single_outbreak_one_seed$`current-inpatients`)
init_N <- unique(single_outbreak_one_seed$`community-colonisation-rate`) * total_patients
init_I <- total_patients - init_N
initial_state <- c(N = init_N, I = init_I)  # Initial populations of non-infected and infected patients
time <- seq(0, run_to, by = 1)         # Time steps
dt <- 1                             # Time step size

plan(multisession)
ode_sims <- furrr::future_pmap_dfr(rate_grid,
        \(b_base, b_out, c_base, c_out, r) {
          N <- numeric(length(time))
          I <- numeric(length(time))
          N[1] <- initial_state["N"]
          I[1] <- initial_state["I"]

          # Euler method for numerical integration with time-varying parameters
          for (t in 1:(length(time) - 1)) {
            # Current beta value
            beta_t <- beta_function(time[t], b_base, b_out)
            p_t <- beta_function(time[t], c_base, c_out)
            
            # Total population at current time
            total <- N[t] + I[t]
            
            # Proportions of non-infected and infected
            prop_N <- ifelse(total > 0, N[t] / total, 0)
            prop_I <- ifelse(total > 0, I[t] / total, 0)
            
            # Calculate derivatives
            dN <- p_t * parameters$A - parameters$A * prop_N - beta_t * N[t]  - r * N[t]
            dI <- (1 - p_t) * parameters$A - parameters$A * prop_I + beta_t * N[t]  + r * N[t]
            
            # Update populations using Euler's method
            N[t + 1] <- N[t] + dN * dt
            I[t + 1] <- I[t] + dI * dt
          }
          data.frame(baseline = mean(I[31:200] / ( N[31:200] + I[31:200] )),
                     outbreak = mean(I[1100:1200] / ( N[1100:1200] + I[1100:1200] )))
        })

abc_single_outbreak <- abc(c(target_baseline_rate, target_outbreak_rate), rate_grid, ode_sims[c("baseline", "outbreak")], tol=0.025, method='rejection')


baselinerate <- mean(abc_single_outbreak$unadj.values[, "b_base"])
outbreakrate <- mean(abc_single_outbreak$unadj.values[, "b_out"])

# baselinecolonisation <- 1 - unique(single_outbreak_sim$`community-colonisation-rate`)
# outbreakcolonisation <- 1 - unique(single_outbreak_sim$`o-community-colonisation-rate`)
baselinecolonisation <- mean(abc_single_outbreak$unadj.values[, "c_base"])
outbreakcolonisation <- mean(abc_single_outbreak$unadj.values[, "c_out"])
r <- mean(abc_single_outbreak$unadj.values[, "r"])

# Initialize vectors to store results
N <- numeric(length(time))
I <- numeric(length(time))
N[1] <- initial_state["N"]
I[1] <- initial_state["I"]

# Euler method for numerical integration with time-varying parameters
for (t in 1:(length(time) - 1)) {
  # Current beta value
  beta_t <- beta_function(time[t], baselinerate, outbreakrate)
  p_t <- beta_function(time[t], baselinecolonisation, outbreakcolonisation)
  
  # Total population at current time
  total <- N[t] + I[t]
  
  # Proportions of non-infected and infected
  prop_N <- ifelse(total > 0, N[t] / total, 0)
  prop_I <- ifelse(total > 0, I[t] / total, 0)
  
  # Calculate derivatives
  dN <- p_t * parameters$A - parameters$A * prop_N - beta_t * N[t]  - r * N[t]
  dI <- (1 - p_t) * parameters$A - parameters$A * prop_I + beta_t * N[t]  + r * N[t]
  
  # Update populations using Euler's method
  N[t + 1] <- N[t] + dN * dt
  I[t + 1] <- I[t] + dI * dt
}

# Combine results into a data frame for plotting
output_df <- data.frame(
  time = time,
  N = N,
  I = I
)

output_df <- filter(output_df, time > 31)
output_long <- reshape2::melt(output_df, id = "time")
```

```{r fig-single-outbreak-deterministic, include=TRUE}
#| echo: false
single_outbreak_one_seed %>% 
  pivot_longer(cols = c(`current-colonised`, `current_not_infected`), names_to = "compartment", values_to = "value") %>%
  filter(`[step]` > 31) %>%
  group_by(compartment, `[step]`) %>% 
  summarise(m = mean(value)) %>% 
  ggplot(aes(x = `[step]`, y = m, color = compartment)) +
  geom_line() +
  labs(title = "Dynamics of Non-Infected and Infected Patients (Time-Varying Beta)",
       x = "Time",
       y = "Number of Patients",
       color = "Compartment") +
  geom_line(data = output_df, aes(x = time, y = N), color = "blue") + 
  geom_line(data = output_df, aes(x = time, y = I), color = "red") +
  xlim(500, 2000)
```

# Discussion

Infection prevention and control (IPC) is the practice of preventing the spread of infectious diseases in healthcare settings. A central responsibility is the operational management of an outbreak, defined as an increase in the number of infected cases above the expected rate. This research describes the design and calibration of an agent-based model that simulates the spread of infection in a hospital setting. The primary motivation of this work is to assess the impact of different infection prevention interventions (such as change in practice) on rates of infection. The model was designed to simulate a paradigm of infections that are faecal-oral-transmitted, with the risk increasing in the presence of the selective pressure introduced by antimicrobial therapy. Since some of the pathogens that fit this definition may be associated with long-term colonisation of the gastro-intestinal tract (without the presence of clinical illness), infection and colonisation are used inter-changeably within this research. The model can be used to simulate any infection with these characteristics, such as: _Clostridioides difficile_, vancomycin-resistant _Enterococcus_, extended-spectrum beta-lactamase-producing Enterobacterales, and carbapenem-resistant _Enterobacterales_.

The model was designed to simulate the spread of infection/colonisation at a baseline (or background) rate, followed by an outbreak period of increased transmission, in turn followed by a period of enhanced infection control to return back to the baseline rate. The model was calibrated to a report of a _C. difficile_ outbreak reported by @salgadoAnalysisOutbreakClostridium2009. Approximate Bayesian computation was used to calibrate the model to the rates of infection reported in the paper. When model inputs were drawn from the posterior distributions, the model was able to simulate plausible outbreak scenarios that were similar to the observed rates. A sensitivity analysis was performed over parameters that represent infection control interventions (such as the frequency of toilet cleaning), demonstrating the possible applications of this model for informing operational infection control practices. Interventions that controlled the spread of infection, such as the cohorting of patients to single-occupancy beds, and the increased frequency of toilet cleaning, led to a reduced number of cases during the outbreak period.

To simulate outbreaks and periods of enhanced infection control, the model was designed to change parameters at discrete time points. For example, the rate of antimicrobial prescriptions was higher during the outbreak period, promoting the spread of infection and colonisation. Later, the prescription rate was reduced to help control the outbreak. The NetLogo model implementation was designed so that a fixed parameter set was used as an input, and the outbreak and enhanced IPC parameters were only used during their respective periods. In effect, all input parameters were provided as a fixed input -- some parameters were only used by the simulation at defined discrete intervals. This approach may be unsuitable for modelling of transmission without a clear outbreak pattern -- more complex implementations of time-varying parameters could be explored.

Although agent-based models have been shown to be useful for simulating and modelling infectious disease transmission, they have limitations. The model described here is a simplification of what is likely to be a highly intricate and complicated system. For example, transmission was assumed to be 'random' or acquired through the use of a contaminated toilet. In reality, other transmission pathways likely exist, such as through contact with staff or contaminated bedding. Antimicrobial exposure was considered to be a binary risk factor for an agent becoming infected or colonised. Antimicrobial class and duration of exposure are factors that are not accounted for in this model. An agent-based model that captures all the details that influence the spread of infection in a hospital setting is unlikely to be feasible, due to the computational challenge and the large number of parameters that would need to be estimated. A reasonable approach is for the model to be as simple as possible, while still capturing the features required to answer the research question [@sunSimpleComplicatedAgentbased2016]. Another limitation of agent-based models is the requirement for detailed data to calibrate and validate the model. Here, the data used was primarily from a retrospective descriptive dataset. As such, information on certain parameters was not available (e.g., the proportion of patients that were administered an antimicrobial during their admission) -- these parameters were estimated from the literature. An important future direction would be to prospectively inform and validate the model with data collected specifically for this purpose.

Agent-based models that simulate the hospital transmission of pathogens transmitted through the faecal-oral route, including _C. difficile_ and vancomycin-resistant _Enterococci_, have been reported previously [@codellaAgentbasedSimulationModel2015; @debosckerAgentbasedModelSimulate2021]. Some models have also explored the impact of one or more infection control interventions on the spread of infection [@barkerInterventionsReduceIncidence2018; @rubinSimulationBasedAssessmentStrategies2013]. Our model builds on these works by designing and calibrating the model to an outbreak and enhanced IPC period. The motivation for this was to design a model that can be used to support infection and prevention teams in the following: 1) preparedness for outbreak situations; and 2) decision-making on the implementation of infection control interventions during an outbreak. Furthermore, the model was designed to be pathogen-agnostic to allow for a stepwise approach for future work -- pathogen-specific features (e.g., diagnostic and laboratory testing) can be added as required. The choice of NetLogo as a platform allows for the model to be used interactively by non-programmers, such as infection control practitioners; the model can also be modified and extended with the relatively simple NetLogo language.

In conclusion, the agent-based model described here can simulate outbreaks of infection in a hospital setting, and estimate the impact of different infection control interventions on the number of nosocomial infections. Although the model was calibrated to a _C. difficile_ outbreak, it can be adapted for use in other pathogens that are transmitted through the faecal-oral route under antimicrobial selective pressure, such as vancomycin-resistant _Enterococci_ and extended-spectrum beta-lactamase-producing Enterobacterales.
