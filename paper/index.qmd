---
title: Paper
authors:
  - name: Alessandro Gerada
    affiliation: University of Liverpool
    roles: writing
    corresponding: true
bibliography: references.bib
---

# Background

```{r, include=FALSE}

# I could not get R code to run before, until I did this:
# https://github.com/brentthorne/posterdown/issues/42

# to change body font size:
# change this line in typst-template.typ:
# set text(font: "STIX Two Text", size: 24pt)
library(tidyverse)
library(abc)
source(file.path("..", "calibrate.R"))
# load(file.path("..", "out", "calibrate.RData"))
```

Transmission of potentially pathogenic bacteria under antimicrobial selective pressure has important implications for control of hospital-acquired infection. Examples include *Clostridioides difficile* infection (CDI) and Vancomycin-resistant *Enterococcus*. In addition to patient factors, colonisation risk depends on environmental factors (e.g., surface cleaning), proximity to other colonised patients, and use of antimicrobial agents. To guide infection control strategies, especially during outbreaks, we developed an agent-based simulator and estimated its parameters using data from a CDI outbreak documented by Salgado et al @salgado2009.

# Methods

## Agent-based model

An agent-based model (ABM) was implemented using NetLogo [@wilenskyu.1999]. Briefly, the simulation started by building a virtual hospital with a configurable high-level structure, defined by its number of wards, beds per ward, and proportion of bedspaces sharing toilet facilities. Next, the hospital was populated with patients, each having an infected/colonised or non-infected/colonised state, defined as:

$$
x_p(t) \epsilon \{0, 1\}
$$

where:

-   $x_p(t) = 0$ if patient $p$ is not infected/colonised at time $t$,
-   $x_p(t) = 1$ if patient $p$ is infected/colonised at time $t$. It was assumed that infection/colonisation was not reversible during the simulation, i.e., that infected/colonised patients remained so until discharge. Hence, in contrast to a traditional susceptible-infected-recovered model [@anderson1991], the differential equations of this model were:

$$
\frac{dH_S}{dt} = A_S - QH_S(t)H_I(t) - DH_S(t)
$$

$$
\frac{dH_I}{dt} = A_I + QH_S(t)H_I(t) - DH_I(t)
$$

where:

-   $dH_s/dt$ is the rate of
-   $H_S$ is the number of susceptible inpatients,
-   $H_I$ is the number of infected inpatients,
-   $A_S$ is the rate of new susceptible admissions,
-   $A_I$ is the rate of new infected admissions,
-   $Q$ is the transmission coefficient,
-   $D$ is the rate of patients that are discharged.

The hospital capacity was constantly kept at 100% occupancy (i.e., patients were immediately replaced on discharge), therefore:

$$
D = A_S + A_I
$$

At each time increment, the probability of a non-colonised/infected patient acquiring infection (i.e., transitioning from a non-infected/colonised to infected/colonised state) depended on: 1) a baseline risk of *de novo* infection/colonisation:

$$ 
P_\text{de novo}(t) = 1 - \exp {( - r_0 T(t) )}
$$

and 2) the usage of contaminated toilets:

$$
P_\text{toilet}(t) = 1 - \exp ( {-\sum_{j=0}^{U_i(t)}[C(t_j) \cdot T(t)]} )
$$

where:

-   $R_i(t)$ is the risk of patient $i$ acquiring infection/colonisation at time $t$,

-   $r_0$ is the baseline/*de novo* risk of infection/colonisation,

-   $T(t)$ is a binary indicator for antimicrobial therapy:

$$
\mathrm{T}(t) = \begin{cases}
    m & \text{if on antimicrobial therapy} \\ % & is your "\tab"-like command (it's a tab alignment character)
    1 & \text{otherwise.}
\end{cases}
$$

-   $m$ is the increased (or decreased) relative risk of infection/colonisation due to antimicrobial therapy,

-   $U_i(t)$ is the number of times patient $i$ frequents the toilet within the time interval $t$,

-   $C(t_j)$ is the contamination level of the toilet at time $t_j$.

The agent-based model conducted Bernoulli trials to determine if a patient acquired infection/colonisation at each time step $t$:

$$
X_\text{de novo} \sim \text{Bernoulli}(P_\text{de novo}(t)),
$$

where $X_\text{de novo}$ = 1 if patient acquires infection/colonisation *de novo* at time $t$, and 0 otherwise.

$$
X_\text{toilet} \sim \text{Bernoulli}(P_\text{toilet}(t)),
$$

where $X_\text{toilet}$ = 1 if patient acquires infection/colonisation from a contaminated toilet at time $t$, and 0 otherwise.

The results of the trials were combined to determine the outcome for patient $i$ at time $t$:

$$
X_i(t) = \max(X_\text{de novo}, X_\text{toilet}),
$$

where $X_i(t)$ = 1 if patient $i$ acquires infection/colonisation at time $t$, and 0 otherwise.

## Model inputs and outputs

Model input parameters were broadly grouped into: 1) toilet (e.g., number of times toilet used per day, level of contamination after use or cleaning); 2) admission (e.g., community colonisation rate, antimicrobial prescription rate); and 3) colonisation parameters (e.g., relative risk increase of antimicrobial therapy on colonisation/infection).

The outputs of the model included: 1) number of patients admitted; 2) number of patients with community-acquired colonisation/infection; 3) number of patients with hospital-acquired (nosocomial) colonisation/infection. The simulation was run with each unit of time corresponding to one day; therefore, the model's outputs were for each simulated day.

## Data sources

Data from a hospital *Clostridioides difficile* infection (CDI) outbreak reported by Salgado et al was used to parameterise and calibrate the model [@salgado2009]. Raw data from this study were not available, therefore, the Engauge digitizer software was used to extract observed CDI rates from the manuscript's figures [@mitchell2020].

## Model calibration

Rejection sampling approximate Bayesian computation was employed to calibrate the model to the outbreak data [@sunnÃ¥ker2013]. Priors were determined from domain knowledge or extracted from existing literature. The parameters in @tbl-consts were kept constant during the calibration process.

Firstly, latin hypercube sampling was used to generate $n$ samples from the parameter prior distributions, using a uniform distribution, such that $\theta_1,\theta_2,\ldots,\theta_n$. Next, each sample parameter point $\theta_i$ was used as an input to the agent-based model, generating a total of $n$ simulated datasets. The number of daily cases of nosocomial CDI were extracted from the model outputs, and converted to a time series of nosocomial CDI per 1000 patient days for each month, generating simulated summary statistics $S_1,S_2,\ldots,S_n$. Results from the first 30 simulated days were discarded to ensure that the model had reached a steady state.

Each simulated summary statistic $S_i$ was compared to the summary statistic generated from the observed data, $S_\text{obs}$, and $S_i$ was accepted if:

$$
d(S_i, S_\text{obs}) \leq \epsilon,
$$

where:

-   $d$ is the Euclidean distance between $S_i$ and $S_\text{obs}$, and

-   $\epsilon$ is the tolerance.

Otherwise, $S_i$ was rejected. The parameter samples that generated the accepted simulations were used to generate a posterior distribution.

Firstly, the model was calibrated to pre-outbreak data to identify parameters that simulated the baseline rate. Next, we simulated the emergence of an outbreak and its subsequent control by incrementally raising colonisation pressure over time (via increased antimicrobial consumption, toilet use, etc.) and enhancing infection control measures, respectively. Finally, the posterior parameter distributions were used to simulate 20 outbreaks.

| Name                                                       | Value    | Description                                                             | Reference                |
|------------------|------------------|-------------------|------------------|
| Baseline (pre-outbreak) antimicrobial prescription rate    | 0.319    | Proportion of patients administered antimicrobials during admission     | @versporten2018          |
| Admission duration                                         | 8.3 days | Mean of a Poisson distribution                                          | @thehealthfoundation2023 |
| Proportion of toilets that are shared between \>1 patients | 0.6      | The remaining proportion (0.4) of toilets were dedicated to one patient | N/A                      |

: Parameters that were assumed to be constant during calibration. {#tbl-consts}

![Screenshot of model graphical user interface during a simulation run](./images/screenshot.png){#fig-screenshot height="30%"}

Users can run the model interactively using the interface shown in @fig-screenshot.

## Outbreak generation

To simulate the generation of outbreaks and their subsequent control through enhanced infection prevention and control (IPC) measures, the agent-based model optionally changed its parameters at four configurable discrete time points within the simulation: 1) onset of outbreak; 2) start of enhanced IPC measures; 3) end of outbreak; and 4) end of enhanced IPC measures. Changes in parameters such as increased antimicrobial prescription rates and decreased toilet cleaning frequency were used to encourage increased disease transmission, leading to an outbreak. On the other hand, these parameters were reversed to control the outbreak.

## Model availability

# Results

```{r, echo=FALSE}
posteriors <- abc_params_outbreak_control$unadj.values
comm_colonisation <- round(mean(posteriors[, "community-colonisation-rate"] * 100), 2)
outbreak_colonisation <- round(mean(posteriors[, "o-community-colonisation-rate"] * 100), 2)
outbreak_antibiotic_rate <- round(mean(posteriors[, "o-antibiotic-prescription-rate"] * 100), 2)
control_antibiotic_rate <- round(mean(posteriors[, "c-antibiotic-prescription-rate"] * 100), 2)
```

After calibration, key parameters included: community colonisation rate of `r comm_colonisation`%, rising to `r outbreak_colonisation`% during the outbreak period. Furthermore, the proportion of patients prescribed an antimicrobial during their admission increased from `r consts[["antibiotic-prescription-rate"]] * 100`% to `r outbreak_antibiotic_rate`% during the outbreak; then reduced to `r control_antibiotic_rate`% during the period of enhanced infection control measures. The posterior parameter distributions are shown in @fig-posterior-densities. Simulated data had a pre-outbreak baseline median rate of `r round(pre_outbreak_sims_rates$rate_median, 2)` cases per 1000 patient days \[interquartile (IQR) range `r round(pre_outbreak_sims_rates$rate_q_low, 2)`--`r round(pre_outbreak_sims_rates$rate_q_high, 2)`\], compared with the real rate of 1.25 cases per 1000 \[IQR 0.94--1.56\]. During the outbreak period, simulations had a median rate of `r round(outbreak_sims_rates$rate_median, 2)` \[IQR `r round(outbreak_sims_rates$rate_q_low, 2)`--`r round(outbreak_sims_rates$rate_q_high, 2)`\] cases, compared with the real median rate of 3.74 \[IQR 3.32--4.41\] (see @fig-simulated-rates).

```{r}
#| eval: true
#| echo: false
#| fig.width: 18
#| fig.height: 8
#| warning: false
#| label: fig-posterior-densities
#| fig-cap: "Changes in parameters during outbreak and enhanced infection control periods. Density plots show the posterior distributions of key simulation parameters after calibration using approximate Bayesian computation."
#| fig-subcap:
#|   - "General parameters"
#|   - "Toilet-related parameters"
#| layout-ncol: 1
abc_params_outbreak_control$unadj.values %>% 
  as_tibble %>% 
  dplyr::select(-`outbreak-start`, -`outbreak-end`, -`control-end`,
                -`antibiotic-effect`,
                -`random-colonisation`) %>% 
  dplyr::select(!contains("toilet")) %>% 
  pivot_longer(cols=everything()) %>%
  mutate(type = case_when(
    str_starts(name, "o-") ~ "Outbreak",
    str_starts(name, "c-") ~ "Control",
    .default = "Baseline")) %>%
  mutate(name = str_remove(name, "^o-|^c-")) %>%
  mutate(name = str_replace_all(name, "-", " ")) %>%
  mutate(name = str_to_title(name)) %>% 
  # change type to ordered factor
  mutate(type = factor(type, levels = c("Baseline", "Outbreak", "Control"))) %>%
  ggplot(aes(x = value, ..scaled.., fill = type)) +
  geom_density(alpha = 0.1) +
  facet_wrap(~name, scales = "free_x") +
  # remove y axis
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("Parameter value") + 
  theme(legend.title = element_blank(),
        text=element_text(size=24)) + 
  # manually set colors
  scale_fill_manual(values = c("Baseline" = "green", "Outbreak" = "red", "Control" = "blue"))

abc_params_outbreak_control$unadj.values %>% 
  as_tibble %>% 
  dplyr::select(-`outbreak-start`, -`outbreak-end`, -`control-end`,
                -`antibiotic-effect`,
                -`random-colonisation`) %>% 
  dplyr::select(contains("toilet")) %>% 
  pivot_longer(cols=everything()) %>%
  mutate(type = case_when(
    str_starts(name, "o-") ~ "Outbreak",
    str_starts(name, "c-") ~ "Control",
    .default = "Baseline")) %>%
  mutate(name = str_remove(name, "^o-|^c-")) %>%
  mutate(name = str_replace_all(name, "-", " ")) %>%
  mutate(name = str_to_title(name)) %>% 
  # change type to ordered factor
  mutate(type = factor(type, levels = c("Baseline", "Outbreak", "Control"))) %>%
  ggplot(aes(x = value, ..scaled.., fill = type)) +
  geom_density(alpha = 0.1) +
  facet_wrap(~name, scales = "free_x") +
  # remove y axis
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("Parameter value") + 
  theme(legend.title = element_blank(),
        text=element_text(size=24)) + 
  # manually set colors
  scale_fill_manual(values = c("Baseline" = "green", "Outbreak" = "red", "Control" = "blue"))
```

```{r}
#| echo: false
#| label: fig-simulated-rates
#| fig.cap: "Observed and simulated rates of _C. difficile_ infection over the simulated period. Approximate Bayesian computation was used to determine the unobserved parameters of the agent-based model. The red line shows the true observed infection rates. The black solid line shows the mean simulated rates; the dashed lines show the standard deviation."
#| fig.width: 18
#| fig.height: 8
ggplot(long_observed_ss, aes(x = x, y = rates)) + geom_line(color = 'red') +
  geom_line(data = sim_mean, aes(x = x, y = m)) +
  geom_line(data = sim_mean, aes(x = x, y = q_high), linetype='dashed') +
  geom_line(data = sim_mean, aes(x = x, y = q_low), linetype='dashed') + 
  theme(text=element_text(size=24)) +
  xlab("Date") + ylab("Rate (cases per 1000 patient days)")
```

```{r}
#| echo: false
#| fig.width: 18
#| fig.height: 8
#| include: false
#| message: false
consts_sim_rates %>% 
  pivot_wider(names_from = date_sim, values_from = rate) %>% 
  #slice_sample(n=10) %>% 
  pivot_longer(cols = !c(`random-seed`, `siminputrow`), names_to = "date_sim", values_to = "rate") %>% 
  mutate(date_sim = ymd(date_sim)) %>% 
  group_by(siminputrow, date_sim) %>%
  summarise(rate = mean(rate)) %>%
  ggplot(aes(x = date_sim,
             y = rate,
             color = factor(`siminputrow`))) +
  geom_line() +
  geom_line(data = long_observed_ss, aes(x = x, y = rates), color = "black") +
  guides(color="none")
```

# Discussion

Repeated simulations using the model generated nosocomial CDI rates that showed a clear outbreak peak, followed by control of colonisation/infection through a change in infection control practice, resembling a real hospital CDI outbreak. The interactive nature of the model can be used for outbreak preparedness by testing out different infection control strategies. In summary, we report a pathogen-agnostic model that can be used to simulate any infection with features such as faecal-oral transmission, colonisation, and antimicrobial selective pressure effects.
